{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "GetPurchases": {
      "main": [
        [
          {
            "node": "CreateMessage2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "GetPurchases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-09T14:07:09.597Z",
  "id": "mQlMEWslapqFJFmq",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "NR0002 | Notifications Reports | Chart Launch",
  "nodes": [
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT * FROM vw_notifications_reports_launch_capt_week WHERE launch_tag = $1 ",
        "options": {
          "queryReplacement": "={{ $json.body.tag }}"
        }
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        192,
        0
      ],
      "id": "1a8b7fdd-5044-4471-9ff7-3d3d642187f4",
      "name": "GetPurchases",
      "credentials": {
        "mySql": {
          "id": "SLbk0R6796E4DmlD",
          "name": "MySQL infoproduct"
        }
      }
    },
    {
      "parameters": {
        "path": "notifications/chart/launch",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "0c8ce8a6-4002-4006-9f4e-ee320bb8b786",
      "name": "Webhook",
      "webhookId": "1d7cb32d-1efa-4781-9082-b3997957a05a"
    },
    {
      "parameters": {
        "jsCode": "// === CONFIGURAÃ‡Ã•ES DO GRÃFICO ===\nconst groupKey     = 'launch_tag';\nconst width        = 620;\nconst height       = 1080;\nconst bgColor      = 'white';\nconst chartVersion = '4';\nconst baseUrl      = 'https://quickchart.io/chart';\nconst pluginsParam = 'chartjs-plugin-datalabels';\n\n// === FUNÃ‡Ã•ES AUXILIARES ===\nconst N = (v) => {\n  const n = parseFloat(v);\n  return Number.isFinite(n) ? n : 0;\n};\nfunction labelBR(ymd) {\n  if (!ymd) return '';\n  const [y, m, d] = ymd.split('-');\n  return `${d}/${m}`;\n}\n\n// === PROCESSAMENTO DOS DADOS DE ENTRADA ===\nconst rows = $input.all().map(i => i.json);\nif (!rows.length) {\n  return [];\n}\n\n// === PREPARAÃ‡ÃƒO DOS DADOS PARA O GRÃFICO ===\nconst tag = rows[0][groupKey] || 'LanÃ§amento';\nconst labels           = rows.map(r => labelBR(r.report_date));\nconst cplMetaSeries    = rows.map(r => N(r.cpl_meta_dia));\nconst cplGoogleSeries  = rows.map(r => N(r.cpl_google_dia));\nconst cplTotalSeries   = rows.map(r => N(r.cpl_total_dia));\n\n// === NOVO: CÃLCULO DINÃ‚MICO DOS LIMITES DO EIXO Y ===\n// 1. Junta todos os valores de CPL em um Ãºnico array\nconst allCplValues = [...cplMetaSeries, ...cplGoogleSeries, ...cplTotalSeries];\n\n// 2. Filtra os valores que sÃ£o zero para nÃ£o influenciar o cÃ¡lculo do mÃ­nimo\nconst nonZeroValues = allCplValues.filter(v => v > 0);\n\n// 3. Encontra o valor mÃ­nimo e mÃ¡ximo de todo o perÃ­odo\n//    Se nÃ£o houver valores > 0, o mÃ­nimo padrÃ£o Ã© 0.\nconst overallMin = nonZeroValues.length > 0 ? Math.min(...nonZeroValues) : 0;\nconst overallMax = Math.max(...allCplValues);\n\n// 4. Define os limites do eixo Y com a margem de 3 pontos, garantindo que o mÃ­nimo nÃ£o seja negativo\nconst yAxisMin = Math.max(0, overallMin - 3);\nconst yAxisMax = overallMax + 3;\n\n\n// === CORES PARA AS LINHAS DO GRÃFICO ===\nconst BLUE   = 'rgba(59, 130, 246, 1)';   // CPL Meta\nconst RED    = 'rgba(239, 68, 68, 1)';    // CPL Google\nconst BLACK  = 'rgba(31, 41, 55, 1)';     // CPL Total\n\n// === MONTAGEM DO GRÃFICO (OBJETO DE CONFIGURAÃ‡ÃƒO DO CHART.JS) ===\nconst cfg = {\n  type: 'line',\n  data: {\n    labels: labels,\n    datasets: [\n      { label: 'CPL Meta', data: cplMetaSeries, borderColor: BLUE, tension: 0.3, borderWidth: 3, pointBackgroundColor: BLUE, pointRadius: 3, fill: false },\n      { label: 'CPL Google', data: cplGoogleSeries, borderColor: RED, tension: 0.3, borderWidth: 3, pointBackgroundColor: RED, pointRadius: 3, fill: false },\n      { label: 'CPL Total', data: cplTotalSeries, borderColor: BLACK, tension: 0.3, borderWidth: 4, borderDash: [8, 4], pointBackgroundColor: BLACK, pointRadius: 4, fill: false }\n    ]\n  },\n  options: {\n    responsive: true,\n    plugins: {\n      title: { display: true, text: `${tag} â€” CPLs dos Ãºltimos 7 dias (atÃ© ${labels[labels.length - 1]})` },\n      legend: { position: 'top' },\n      datalabels: {\n        align: 'top',\n        anchor: 'end',\n        backgroundColor: 'rgba(255,255,255,0.7)',\n        borderRadius: 4,\n        color: (ctx) => ctx.dataset.borderColor,\n        font: { size: 10, weight: '600' },\n        formatter: (value) => `R$ ${(Number(value) || 0).toFixed(2)}`,\n      },\n    },\n    scales: {\n      y: {\n        // === ATUALIZAÃ‡ÃƒO DO EIXO Y ===\n        // Removemos 'beginAtZero' e 'grace' e definimos os limites manualmente\n        min: yAxisMin,\n        max: yAxisMax,\n        ticks: {\n          // Garante que os rÃ³tulos do eixo (5, 10, 15...) sejam formatados como R$\n          callback: (value) => `R$ ${Number(value).toFixed(2)}`\n        }\n      }\n    }\n  }\n};\n\n// === GERAÃ‡ÃƒO DA URL E SAÃDA ===\nconst url =\n  `${baseUrl}?version=${chartVersion}&width=${width}&height=${height}` +\n  `&backgroundColor=${encodeURIComponent(bgColor)}` +\n  `&plugins=${encodeURIComponent(pluginsParam)}` +\n  `&c=${encodeURIComponent(JSON.stringify(cfg))}`;\n\nreturn [{\n  json: {\n    launch_tag: tag,\n    image: url,\n    message: `Segue o grÃ¡fico com a variaÃ§Ã£o dos CPLs nos Ãºltimos 7 dias para o lanÃ§amento ${tag}.`\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        208
      ],
      "id": "5d566b32-81d4-4646-98f9-069e36f7a26b",
      "name": "CreateMessage"
    },
    {
      "parameters": {
        "jsCode": "// === CONFIGURAÃ‡Ã•ES DO GRÃFICO ===\nconst groupKey     = 'launch_tag';\nconst width        = 620;\nconst height       = 620;\nconst bgColor      = 'white';\nconst chartVersion = '4';\nconst baseUrl      = 'https://quickchart.io/chart';\nconst pluginsParam = 'chartjs-plugin-datalabels';\n\n// === FUNÃ‡Ã•ES AUXILIARES ===\nconst N = (v) => {\n  const n = parseFloat(v);\n  return Number.isFinite(n) ? n : 0;\n};\nfunction labelBR(ymd) {\n  if (!ymd) return '';\n  const [y, m, d] = ymd.split('-');\n  return `${d}/${m}`;\n}\n\n// === PROCESSAMENTO DOS DADOS DE ENTRADA ===\nconst rows = $input.all().map(i => i.json);\nif (!rows.length) {\n  return [];\n}\n\n// === PREPARAÃ‡ÃƒO DOS DADOS PARA O GRÃFICO ===\nconst tag = rows[0][groupKey] || 'LanÃ§amento';\nconst labels           = rows.map(r => labelBR(r.report_date));\nconst cplMetaSeries    = rows.map(r => N(r.cpl_meta_dia));\nconst cplGoogleSeries  = rows.map(r => N(r.cpl_google_dia));\nconst cplTotalSeries   = rows.map(r => N(r.cpl_total_dia));\n\n// === CÃLCULO DINÃ‚MICO DOS LIMITES DO EIXO Y ===\nconst allCplValues = [...cplMetaSeries, ...cplGoogleSeries, ...cplTotalSeries];\nconst nonZeroValues = allCplValues.filter(v => v > 0);\n\nconst overallMin = nonZeroValues.length > 0 ? Math.min(...nonZeroValues) : 0;\nconst overallMax = Math.max(...allCplValues);\n\nconst yAxisMin = Math.max(0, Math.floor(overallMin - 1));\nconst yAxisMax = Math.ceil(overallMax + 1);\n\n// === CORES PARA AS LINHAS DO GRÃFICO ===\nconst BLUE   = 'rgba(59, 130, 246, 1)';\nconst RED    = 'rgba(239, 68, 68, 1)';\nconst GRAY   = 'rgba(107, 114, 128, 1)';\n\n// === MONTAGEM DO GRÃFICO (OBJETO DE CONFIGURAÃ‡ÃƒO DO CHART.JS) ===\nconst cfg = {\n  type: 'line',\n  data: {\n    labels: labels,\n    datasets: [\n      {\n        label: 'CPL Meta',\n        data: cplMetaSeries,\n        borderColor: BLUE,\n        tension: 0.3, borderWidth: 3, pointBackgroundColor: BLUE, pointRadius: 3, fill: false,\n        datalabels: {\n          color: BLUE, // Cor especÃ­fica para esta linha\n          align: 'top',\n          anchor: 'end',\n          backgroundColor: 'rgba(255,255,255,0.7)',\n          borderRadius: 4,\n          font: { size: 10, weight: '600' },\n          formatter: (value) => `R$ ${(Number(value) || 0).toFixed(2)}`,\n        }\n      },\n      {\n        label: 'CPL Google',\n        data: cplGoogleSeries,\n        borderColor: RED,\n        tension: 0.3, borderWidth: 3, pointBackgroundColor: RED, pointRadius: 3, fill: false,\n        datalabels: {\n          color: RED, // Cor especÃ­fica para esta linha\n          align: 'top',\n          anchor: 'end',\n          backgroundColor: 'rgba(255,255,255,0.7)',\n          borderRadius: 4,\n          font: { size: 10, weight: '600' },\n          formatter: (value) => `R$ ${(Number(value) || 0).toFixed(2)}`,\n        }\n      },\n      {\n        label: 'CPL Total',\n        data: cplTotalSeries,\n        borderColor: GRAY,\n        tension: 0.3, borderWidth: 4, borderDash: [8, 4], pointBackgroundColor: GRAY, pointRadius: 4, fill: false,\n        datalabels: {\n          color: GRAY, // Cor especÃ­fica para esta linha\n          align: 'top',\n          anchor: 'end',\n          backgroundColor: 'rgba(255,255,255,0.7)',\n          borderRadius: 4,\n          font: { size: 10, weight: '600' },\n          formatter: (value) => `R$ ${(Number(value) || 0).toFixed(2)}`,\n        }\n      }\n    ]\n  },\n  options: {\n    responsive: true,\n    plugins: {\n      title: { display: true, text: `${tag} â€” CPLs dos Ãºltimos 7 dias (atÃ© ${labels[labels.length - 1]})` },\n      legend: { position: 'top' },\n      // A configuraÃ§Ã£o global de datalabels Ã© removida para que a especÃ­fica de cada dataset funcione.\n      datalabels: {\n        display: true // Garante que o plugin esteja ativo\n      }\n    },\n    scales: {\n      y: {\n        min: yAxisMin,\n        max: yAxisMax,\n        ticks: {\n          callback: (value) => `R$ ${Number(value).toFixed(2)}`\n        }\n      }\n    }\n  }\n};\n\n// === GERAÃ‡ÃƒO DA URL E SAÃDA ===\nconst url =\n  `${baseUrl}?version=${chartVersion}&width=${width}&height=${height}` +\n  `&backgroundColor=${encodeURIComponent(bgColor)}` +\n  `&plugins=${encodeURIComponent(pluginsParam)}` +\n  `&c=${encodeURIComponent(JSON.stringify(cfg))}`;\n\nconst mensagem = $('Webhook').first().json.body.message\n\nreturn [{\n  json: {\n    launch_tag: tag,\n    image: url,\n    message: mensagem\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        0
      ],
      "id": "a256f7d4-089c-4d36-bc81-f3c13d61f02f",
      "name": "CreateMessage2"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "host": "webhook.sv1.professorsalomaocursos.com.br",
            "user-agent": "axios/1.8.3",
            "content-length": "826",
            "accept": "application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "x-forwarded-for": "172.18.0.1",
            "x-forwarded-host": "webhook.sv1.professorsalomaocursos.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "aac92803f7db",
            "x-real-ip": "172.18.0.1"
          },
          "params": {},
          "query": {},
          "body": {
            "tag": "SSP-L19",
            "message": "ðŸ“Š *RelatÃ³rio de CaptaÃ§Ã£o DiÃ¡ria*\n\n-----------\n*RID1125*\n\n*> Resumo DiÃ¡rio:*\nðŸ‘¤ Leads no dia: *72*\nðŸ’° Investimento no dia: *R$Â 322,31*\nðŸŽ¯ CPL do dia: *R$Â 5,12*\n\n*> Leads do Dia por Origem:*\n- Meta Ads: *47*\n- Google Ads: *16*\n- OrgÃ¢nico: *7*\n- NÃ£o Rastreado: *0*\n\n*> Grupos de WhatsApp (Hoje):*\nðŸ“¥ Entradas: *54*\nÕ¥Õ¬ SaÃ­das: *7*\nðŸ“ˆ Taxa de ConversÃ£o p/ Grupo: *75,00%* (ðŸŸ¢ 13.81% acima da mÃ©dia)\n\n*> Investimento:*\nðŸ‘¥ CPL MetaAds Hoje: *R$Â 0,00* (ðŸŸ¢ 100.00% abaixo da mÃ©dia)\nðŸ‘¥ CPL MetaAds: *R$Â 21,82*\nðŸ‘¥ CPL GoogleAds Hoje: *R$Â 0,00* (ðŸŸ¢ 100.00% abaixo da mÃ©dia)\nðŸ‘¥ CPL GoogleAds: *R$Â 21,82*\nðŸ‘¥ CPL Total Hoje: *R$Â 0,00* (ðŸŸ¢ 72.91% abaixo da mÃ©dia)\nðŸ‘¥ CPL Total: *R$Â 0,00*\nðŸ’¸ Investimento Total: *R$Â 65.455,44*"
          },
          "webhookUrl": "https://webhook.sv1.professorsalomaocursos.com.br/webhook/notifications/chart/launch",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "updatedAt": "2025-12-09T14:07:09.597Z",
      "createdAt": "2025-12-09T14:07:09.597Z",
      "role": "workflow:owner",
      "workflowId": "mQlMEWslapqFJFmq",
      "projectId": "VuiAAhWq61ItL83O"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-01-05T23:52:04.092Z",
  "versionId": "de68592e-673a-41aa-8aa1-6cc84dfb4cc0"
}